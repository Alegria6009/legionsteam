<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Loja - Marketplace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(120deg,#0f2027,#203a43,#2c5364); color:white; padding:20px; }
    .loja-header { display:flex; gap:20px; background:rgba(255,255,255,0.15); backdrop-filter:blur(12px); padding:20px; border-radius:12px; margin-bottom:20px; flex-wrap:wrap; }
    .loja-header img {width:100px;height:100px;object-fit:cover;border-radius:12px;border:2px solid #ffd700;}
    h3 {color:#ffd700;}
    .produtos-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; }
    .produto-card { background:rgba(255,255,255,0.15); backdrop-filter:blur(12px); border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.5); text-align:center; }
    .produto-card img {width:100%; height:150px; object-fit:cover; border-radius:10px; margin-bottom:10px;}
    .btn { background:linear-gradient(135deg,#ff9800,#e6b800); border:none; border-radius:20px; padding:8px 16px; color:#111; font-weight:bold; cursor:pointer;}
    .btn:hover{transform:scale(1.05);}
    .btn.secondary { background:rgba(255,255,255,0.12); color:#fff; }
    .review-text { font-size: 13px; color: rgba(255,255,255,0.7); text-align: left; }
    .stars { color: #ffd700; }
  </style>
</head>
<body>
  <div class="loja-header">
    <img id="logoLoja" src="">
    <div>
      <h2 id="nomeLoja">Nome Loja</h2>
      <p id="descLoja">Descrição</p>
      <p><strong>Email:</strong> <span id="emailLoja"></span></p>
      <p><strong>Telefone:</strong> <span id="telLoja"></span></p>
      <p><strong>Pagamento:</strong> <span id="payLoja"></span></p>
    </div>
  </div>
  <h3>Produtos</h3>
  <div class="produtos-grid" id="produtosLoja"></div>

  <script>
    // --- JS BASE (INCLUA ESTE BLOCO EM CADA HTML) ---
    const API_BASE = "http://localhost:5000/api"; // <<<< AJUSTAR CONFORME SEU BACKEND

    const $ = id => document.getElementById(id); // Helper para document.getElementById
    const escapeHtml = s => { if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const formatKz = n => 'Kz ' + Number(n||0).toLocaleString('pt-PT');
    // Outros helpers (apiPost, apiPut, apiDelete, uid) seriam definidos aqui se fossem necessários nesta página
    async function apiGet(path){
      const r = await fetch(API_BASE + path);
      if (!r.ok) { const errorBody = await r.text(); console.error(`API GET ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
      return r.json();
    }
    // --- FIM DO JS BASE ---

    let currentStoreId = null; // MongoDB _id da loja atual

    async function carregarLoja(){
      const storeId = localStorage.getItem("loja_id"); // Pega o _id da loja selecionada
      if (!storeId) {
        document.body.innerHTML = "<h2>Loja não selecionada. Volte à lista de lojas.</h2>";
        return;
      }
      currentStoreId = storeId;

      try {
        const store = await apiGet(`/stores/${currentStoreId}`); // Busca a loja por _id
        if (!store) { document.body.innerHTML = "<h2>Loja não encontrada.</h2>"; return; }
        
        $('logoLoja').src = store.logo || 'https://via.placeholder.com/100';
        $('nomeLoja').innerText = store.nome || '';
        $('descLoja').innerText = store.descricao || "Sem descrição";
        $('emailLoja').innerText = store.email || '';
        $('telLoja').innerText = store.telefone || '';
        $('payLoja').innerText = store.pagamento || '';

        const produtos = await apiGet(`/products/${currentStoreId}`); // Busca produtos da API
        let html = "";
        if (!produtos || produtos.length === 0) {
          html = "<p style='text-align:center;'>Sem produtos disponíveis no momento.</p>";
        } else {
          for (let i = 0; i < produtos.length; i++) {
            const p = produtos[i];
            const reviews = await apiGet(`/reviews?storeId=${currentStoreId}&productName=${encodeURIComponent(p.nome)}`); // Busca reviews
            let avgRating = 0;
            if (reviews.length > 0) {
              const sumRatings = reviews.reduce((sum, r) => sum + (r.rating || 5), 0);
              avgRating = (sumRatings / reviews.length).toFixed(1);
            }
            const stars = avgRating > 0 ? ('★'.repeat(Math.round(avgRating)) + '☆'.repeat(5-Math.round(avgRating))) : 'Sem avaliações';

            html+=`
              <div class="produto-card">
                <img src="${p.foto || 'https://via.placeholder.com/200'}" alt="${escapeHtml(p.nome)}">
                <h4>${escapeHtml(p.nome)}</h4>
                <p>${escapeHtml(p.desc || "")}</p>
                <p>Kz ${formatKz(p.preco)}</p>
                <p>Stock: ${escapeHtml(p.estoque)}</p>
                <p class="stars">${stars} (${reviews.length})</p>
                <button class="btn" onclick="addCarrinho('${escapeHtml(p.nome)}',${p.preco},'${p._id}')">Adicionar ao Carrinho</button>
                <button class="btn secondary" onclick="verProduto('${currentStoreId}','${p._id}',${i})">Ver Detalhes</button>
              </div>`;
          }
        }
        $('produtosLoja').innerHTML = html;
      } catch (error) {
        console.error("Erro ao carregar loja da API:", error);
        document.body.innerHTML = "<h2>Erro ao carregar loja. Verifique o console do navegador e o backend.</h2>";
      }
    }

    function addCarrinho(nome,preco,productId){ // productIndex não é mais usado, passamos o _id do produto
      let carrinho=JSON.parse(localStorage.getItem("carrinho_cliente")||"[]");
      carrinho.push({ storeId: currentStoreId, productId: productId, nome: nome, preco: preco, qty: 1 }); // Sempre 1 por clique
      localStorage.setItem("carrinho_cliente",JSON.stringify(carrinho));
      alert("✅ Produto adicionado ao carrinho");
    }

    function verProduto(storeId, productId, productLocalIndex){
      // Redireciona para product.html com _id da loja e _id do produto
      window.location.href="product.html?storeId="+storeId+"&productId="+productId+"&productLocalIndex="+productLocalIndex;
    }

    carregarLoja(); // Carrega a loja e seus produtos ao iniciar a página
  </script>
</body>
</html>