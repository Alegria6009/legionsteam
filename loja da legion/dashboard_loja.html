<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Dashboard da Loja</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(120deg,#0f2027,#203a43,#2c5364); color:#fff; padding:20px; }
    .container { max-width:1100px; margin:auto; }
    h1 { text-align:center; color:#ffd700; margin-bottom:20px; }

    /* MENU em pílulas */
    .menu { display:flex; flex-wrap:wrap; justify-content:center; gap:18px; margin-bottom:20px; }
    .menu button { padding:14px 28px; border:none; border-radius:30px; background:#6c757d; color:#fff; font-size:16px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:0.15s; font-weight:500; }
    .menu .active, .menu button:hover { background:#bfc3c7; color:#222; font-weight:bold; }

    /* Seções glass */
    .section { display:none; background:rgba(255,255,255,0.12); backdrop-filter:blur(12px); border-radius:12px; padding:18px; margin-bottom:18px; box-shadow:0 6px 20px rgba(0,0,0,0.4); }
    .section.active { display:block; }

    /* Perfil */
    .loja-card { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    .loja-card img { width:100px;height:100px;border-radius:12px;border:2px solid #ffd700;object-fit:cover; }

    /* Produtos */
    .produto-add input, .produto-add textarea { width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; outline:none; background: rgba(0,0,0,0.28); color:#fff; }
    .produto-card { display:flex; gap:12px; background: rgba(255,255,255,0.06); border-radius:10px; padding:10px; margin-top:10px; align-items:flex-start; }
    .produto-card img { width:70px;height:70px;border-radius:8px;border:1px solid #ffd700;object-fit:cover; }
    .btn-remove { background:crimson; border:none; border-radius:6px; padding:6px 10px; color:#fff; cursor:pointer; margin-top:6px; }
    .btn { background: linear-gradient(135deg,#ff9800,#e6b800); border:none; border-radius:18px; padding:8px 14px; color:#111; font-weight:700; cursor:pointer; margin-top:8px; }

    /* Pedidos */
    .pedido-card { background: rgba(255,255,255,0.06); padding:12px; margin:10px 0; border-radius:10px; }
    .pedido-card p { margin:6px 0; display:flex; gap:8px; align-items:center; }
    .pedido-card img { width:40px;height:40px;border-radius:50%;border:2px solid #ffd700;object-fit:cover; }

    /* Reviews */
    .comentario { background: rgba(0,0,0,0.35); border-left: 3px solid #ffd700; padding:8px; margin:8px 0; border-radius:6px; }

    /* Clients */
    .cliente-card { background: rgba(255,255,255,0.06); padding:8px; border-radius:8px; margin:6px 0; display:flex; justify-content:space-between; align-items:center; }
    .btn-banir { background:crimson; border:none; padding:6px 10px; border-radius:6px; color:#fff; cursor:pointer; }

    select, input[type="text"], textarea { border-radius:8px; padding:8px; border:none; background: rgba(0,0,0,0.28); color:#fff; width:100%; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="titulo">📊 Dashboard da Loja</h1>

    <div class="menu" role="navigation" aria-label="Menu dashboard">
      <button class="active" onclick="showTab(event,'perfil')">🏬 Loja</button>
      <button onclick="showTab(event,'produtos')">🛒 Produtos</button>
      <button onclick="showTab(event,'pedidos')">📦 Pedidos</button>
      <button onclick="showTab(event,'vendas')">📈 Vendas</button>
      <button onclick="showTab(event,'comentarios')">💬 Comentários</button>
      <button onclick="showTab(event,'clientes')">🚫 Clientes</button>
      <button onclick="showTab(event,'config')">⚙️ Definições</button>
    </div>

    <!-- PERFIL -->
    <section id="perfil" class="section active" aria-labelledby="perfil-title">
      <div class="loja-card">
        <img id="lojaLogo" src="https://via.placeholder.com/100" alt="Logo loja">
        <div>
          <h2 id="lojaNome">Minha Loja</h2>
          <p><strong>Email:</strong> <span id="lojaEmail"></span></p>
          <p><strong>Telefone:</strong> <span id="lojaTel"></span></p>
          <p><strong>Endereço:</strong> <a id="lojaEndereco" href="#" target="_blank">Mapa</a></p>
          <p><strong>Categoria:</strong> <span id="lojaCategoria"></span></p>
          <p><strong>Pagamento:</strong> <span id="lojaPagamento"></span></p>
          <p><strong>Nacionalidade:</strong> <span id="lojaNacionalidade"></span></p>
          <p><strong>Descrição:</strong> <span id="lojaDescricao"></span></p>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtos" class="section" aria-labelledby="produtos-title">
      <h2>🛒 Adicionar Produto</h2>
      <div class="produto-add" aria-hidden="false">
        <input type="file" id="fotoProduto" accept="image/*">
        <input type="text" id="nomeProduto" placeholder="Nome do produto">
        <textarea id="descProduto" placeholder="Descrição"></textarea>
        <input type="number" id="precoProduto" placeholder="Preço (Kz)">
        <input type="number" id="estoqueProduto" placeholder="Stock">
        <button class="btn" onclick="addProduto()">+ Adicionar</button>
      </div>
      <h3>Produtos Cadastrados</h3>
      <div id="listaProdutos" aria-live="polite"></div>
    </section>

    <!-- PEDIDOS -->
    <section id="pedidos" class="section">
      <h2>📦 Pedidos Recebidos</h2>
      <div id="listaPedidosLoja"></div>
    </section>

    <!-- VENDAS -->
    <section id="vendas" class="section">
      <h2>📈 Histórico de Vendas</h2>
      <div id="vendaCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="venda-card"><h3>Total Pedidos</h3><p id="totalPedidos">0</p></div>
        <div class="venda-card"><h3>Entregues</h3><p id="pedidosEntregues">0</p></div>
        <div class="venda-card"><h3>Pendentes</h3><p id="pedidosPendentes">0</p></div>
        <div class="venda-card"><h3>Faturamento (Kz)</h3><p id="faturamento">0</p></div>
      </div>
    </section>

    <!-- COMENTÁRIOS -->
    <section id="comentarios" class="section">
      <h2>💬 Comentários</h2>
      <div id="reviewsLoja" class="comentarios-list"></div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="section">
      <h2>🚫 Clientes</h2>
      <div id="listaClientes"></div>
    </section>

    <!-- CONFIG -->
    <section id="config" class="section">
      <h2>⚙️ Definições</h2>
      <label for="idioma">Mudar Idioma:</label>
      <select id="idioma" onchange="trocarIdioma()">
        <option value="pt">🇦🇴 Português</option>
        <option value="en">🇬🇧 English</option>
        <option value="es">🇪🇸 Español</option>
      </select>
      <br><br>
      <button class="btn" onclick="removerLoja()">🗑️ Remover Loja</button>
      <button class="btn" style="margin-left:10px" onclick="sair()">🚪 Sair</button>
    </section>
  </div>

<script>
  // --- BASE JS --- (Embutido em todos os HTMLs)
  const API_BASE = "http://localhost:5000/api"; // <<<< AJUSTAR CONFORME SEU BACKEND

  const $ = id => document.getElementById(id);

  // Helpers para requisições API
  async function apiGet(path){
    const r = await fetch(API_BASE + path);
    if (!r.ok) { const errorBody = await r.text(); console.error(`API GET ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
    return r.json();
  }
  async function apiPost(path, body){
    const r = await fetch(API_BASE + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) { const errorBody = await r.text(); console.error(`API POST ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
    return r.json();
  }
  async function apiPut(path, body){
    const r = await fetch(API_BASE + path, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) { const errorBody = await r.text(); console.error(`API PUT ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
    return r.json();
  }
  async function apiDelete(path){
    const r = await fetch(API_BASE + path, { method: 'DELETE' });
    if (!r.ok) { const errorBody = await r.text(); console.error(`API DELETE ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
    return r.json();
  }
  const escapeHtml = s => { if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
  const formatKz = n => 'Kz ' + Number(n||0).toLocaleString('pt-PT');
  // --- FIM DO BASE JS ---

  let currentStoreId = null; // MongoDB _id da loja atual

  // --- Initial Dashboard Load ---
  async function initDashboard() {
    const localStoreId = localStorage.getItem('loja_id'); // Get the _id from localStorage
    if (!localStoreId) {
        alert("Nenhuma loja selecionada. Redirecionando para criar loja.");
        window.location.href = "criar_loja.html";
        return;
    }
    currentStoreId = localStoreId; // Set global store ID

    try {
        const storeData = await apiGet(`/stores/${currentStoreId}`); // Fetch store by _id
        
        // Populate profile UI
        $('lojaLogo').src = storeData.logo || 'https://via.placeholder.com/100';
        $('lojaNome').innerText = storeData.nome || 'Minha Loja';
        $('lojaEmail').innerText = storeData.email || '';
        $('lojaTel').innerText = storeData.telefone || '';
        $('lojaEndereco').href = storeData.endereco || '#'; // Assuming 'endereco' is stored
        $('lojaCategoria').innerText = storeData.categoria || '';
        $('lojaPagamento').innerText = storeData.pagamento || '';
        $('lojaNacionalidade').innerText = storeData.nacionalidade || '';
        $('lojaDescricao').innerText = storeData.descricao || '';
    } catch (error) {
        console.error("Erro ao carregar dados da loja da API:", error);
        alert("Erro ao carregar dados da loja. Verifique o console do navegador e o backend.");
        // Fallback or redirect if API fails
        // localStorage.removeItem('loja_id');
        // window.location.href = "criar_loja.html";
    }

    // Load initial data for tabs
    renderProdutos();
    carregarPedidosLoja();
    carregarReviewsLoja();
    renderClientes();
  }

  // --- Tab Management ---
  function showTab(evt, id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
    if (evt && evt.target) evt.target.classList.add('active');

    // Load data for specific tabs when activated
    if (id === 'produtos') renderProdutos();
    if (id === 'pedidos' || id === 'vendas') carregarPedidosLoja(); // Both depend on order data
    if (id === 'comentarios') carregarReviewsLoja();
    if (id === 'clientes') renderClientes();
  }

  // --- Funções de Produtos ---
  async function addProduto() {
    if (!currentStoreId) { alert("Loja não carregada."); return; }
    const nome = $('nomeProduto').value.trim();
    const preco = $('precoProduto').value.trim();
    const estoque = $('estoqueProduto').value.trim();
    const desc = $('descProduto').value.trim();
    const fotoFile = $('fotoProduto').files[0];

    if (!nome || !preco || !estoque || !fotoFile) { alert('Preencha todos os campos do produto.'); return; }

    const reader = new FileReader();
    reader.onload = async e => {
      const imgBase64 = e.target.result;
      try {
        const productData = { nome, preco: Number(preco), estoque: Number(estoque), desc, foto: imgBase64 };
        const newProduct = await apiPost(`/products/${currentStoreId}`, productData); // API call
        console.log("Produto adicionado via API:", newProduct);
        alert("Produto adicionado com sucesso!");
        renderProdutos(); // Re-render
        // Clear form
        $('nomeProduto').value = ''; $('precoProduto').value = ''; $('estoqueProduto').value = ''; $('descProduto').value = ''; $('fotoProduto').value = '';
      } catch (error) {
        console.error("Erro ao adicionar produto via API:", error);
        alert(`Erro ao adicionar produto: ${error.message || 'Verifique o console do navegador e o backend.'}`);
      }
    };
    reader.readAsDataURL(fotoFile);
  }

  async function renderProdutos() {
    if (!currentStoreId) return;
    try {
        const apiProducts = await apiGet(`/products/${currentStoreId}`); // API call
        let html = '';
        apiProducts.forEach((p, idx) => {
            html += `
              <div class="produto-card" role="article">
                <img src="${p.foto || 'https://via.placeholder.com/70'}" alt="${escapeHtml(p.nome)}">
                <div>
                  <p><strong>${escapeHtml(p.nome)}</strong></p>
                  <p>${escapeHtml(p.desc || '')}</p>
                  <p>Kz ${formatKz(p.preco)} | Stock: ${escapeHtml(p.estoque)}</p>
                  <button class="btn-remove" onclick="removerProduto('${p._id}', ${idx})">Remover</button>
                </div>
              </div>`;
        });
        $('listaProdutos').innerHTML = html || '<p>Nenhum produto cadastrado</p>';
    } catch (error) {
        console.error("Erro ao renderizar produtos da API:", error);
        $('listaProdutos').innerHTML = '<p>Erro ao carregar produtos.</p>';
    }
  }

  async function removerProduto(productId) { // Removido localIndex, usa _id do produto
    if (!currentStoreId || !productId) return;
    if (!confirm('Tem certeza que deseja remover este produto?')) return;

    try {
        await apiDelete(`/products/${currentStoreId}/product/${productId}`); // API call (new route for _id)
        alert('Produto removido com sucesso!');
        renderProdutos(); // Re-render
    } catch (error) {
        console.error("Erro ao remover produto via API:", error);
        alert(`Erro ao remover produto: ${error.message || 'Verifique o console do navegador e o backend.'}`);
    }
  }

  // --- Funções de Pedidos e Vendas ---
  async function carregarPedidosLoja() {
    if (!currentStoreId) return;
    try {
        const apiOrders = await apiGet(`/orders?storeId=${currentStoreId}`); // API call, filtering by storeId (_id)
        let html = ''; let entregues = 0, pendentes = 0, faturamento = 0;
        
        apiOrders.forEach(p => {
            if (p.status === 'Entregue' || p.status === 'Recebido') { entregues++; faturamento += Number(p.total || 0); }
            else pendentes++;
            html += `
              <div class="pedido-card" role="article">
                <p><img src="${p.customerPhoto || 'https://via.placeholder.com/40'}" alt="cliente"> <strong>Pedido #${p._id}</strong></p>
                <p><strong>Cliente:</strong> ${escapeHtml(p.customerName || 'N/D')}</p>
                <p><strong>Contato:</strong> ${escapeHtml(p.customerEmail || p.customerPhone || 'N/D')}</p>
                <p><strong>Total:</strong> ${formatKz(p.total)}</p>
                <p>Status: <span style="color:${p.status==='Recebido'?'limegreen':(p.status==='Entregue'?'gold':'red')}"><strong>${escapeHtml(p.status)}</strong></span></p>
                <p><em>Última atualização: ${escapeHtml(p.log || '-')}</em></p>
                <div style="margin-top:8px">
                  <button class="btn" onclick="alternarStatusPedido('${p._id}')">
                    ${p.status === 'Entregue' || p.status === 'Recebido' ? '🔄 Marcar Pendente' : '✅ Marcar Entregue'}
                  </button>
                </div>
              </div>`;
        });

        $('listaPedidosLoja').innerHTML = html || '<p>Nenhum pedido para esta loja</p>';
        $('totalPedidos').innerText = apiOrders.length;
        $('pedidosEntregues').innerText = entregues;
        $('pedidosPendentes').innerText = pendentes;
        $('faturamento').innerText = formatKz(faturamento);
    } catch (error) {
        console.error("Erro ao carregar pedidos da API:", error);
        $('listaPedidosLoja').innerHTML = '<p>Erro ao carregar pedidos.</p>';
    }
  }

  async function alternarStatusPedido(orderId) {
    if (!confirm('Alterar o status deste pedido?')) return;
    try {
        const order = await apiGet(`/orders/${orderId}`);
        let newStatus = 'Pendente';
        if (order.status === 'Pendente' || order.status === 'Aguardando Verificação') {
          newStatus = 'Entregue';
        } else if (order.status === 'Entregue' || order.status === 'Recebido') {
          newStatus = 'Pendente';
        }
        
        const updatedOrder = await apiPut(`/orders/${orderId}`, { status: newStatus, log: new Date().toLocaleString() }); 
        
        console.log("Pedido atualizado via API:", updatedOrder);
        // Ao invés de usar localStorage, vamos apenas buscar do backend para manter a integridade
        carregarPedidosLoja(); 
    } catch (error) {
        console.error("Erro ao alternar status do pedido via API:", error);
        alert(`Erro ao alterar status: ${error.message || 'Verifique o console do navegador e o backend.'}`);
    }
  }

  // --- Funções de Comentários (Reviews) ---
  async function carregarReviewsLoja() {
    if (!currentStoreId) return;
    try {
        const apiReviews = await apiGet(`/reviews?storeId=${currentStoreId}`); // API call
        let html = '';
        apiReviews.forEach(r => {
            const stars = '★'.repeat(r.rating || 5) + '☆'.repeat(5 - (r.rating || 5));
            html += `<div class="comentario">
              <img src="${r.customerPhoto || 'https://via.placeholder.com/30'}" alt="avatar" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
              <strong>${escapeHtml(r.customerName || 'Cliente')}</strong> - <em>${escapeHtml(r.productName || 'Produto')}</em> (${stars})<br>
              ${escapeHtml(r.text || '')}<br>
              <small>${escapeHtml(r.createdAt || r.log || '')}</small>
            </div>`;
        });
        $('reviewsLoja').innerHTML = html || '<p>Nenhum comentário para os produtos desta loja.</p>';
    } catch (error) {
        console.error("Erro ao carregar reviews da API:", error);
        $('reviewsLoja').innerHTML = '<p>Erro ao carregar comentários.</p>';
    }
  }

  // --- Funções de Clientes ---
  async function renderClientes() {
    if (!currentStoreId) return;
    try {
        // NOTE: Backend needs an endpoint to get users by role or associated with a store.
        // For now, we'll get all users and filter locally.
        const allUsers = await apiGet('/users');
        const storeUsers = allUsers.filter(u => u.role === 'client' && u.storeId && u.storeId === currentStoreId); // if users had a storeId field
        // A better approach would be to fetch orders for current store and get unique customers from there.
        const allOrders = await apiGet(`/orders?storeId=${currentStoreId}`);
        const customers = {};
        allOrders.forEach(order => {
            if (order.customerName) {
                customers[order.customerName] = { 
                    _id: order.clientRefId, // Assuming clientRefId is in order
                    name: order.customerName, 
                    contact: order.customerEmail || order.customerPhone || 'N/A' 
                };
            }
        });

        let html = '';
        Object.values(customers).forEach(c => { 
            html += `<div class="cliente-card">${escapeHtml(c.name)} (${escapeHtml(c.contact)}) <button class="btn-banir" onclick="banirCliente('${c._id || c.name}')">Banir</button></div>`;
        });
        $('listaClientes').innerHTML = html || '<p>Nenhum cliente registrado ainda</p>';
    } catch (error) {
        console.error("Erro ao carregar clientes da API:", error);
        $('listaClientes').innerHTML = '<p>Erro ao carregar clientes.</p>';
    }
  }

  async function banirCliente(customerIdOrName) {
    if (!confirm(`Tem certeza que deseja BANIR o cliente ${customerIdOrName}? Esta ação é apenas visual aqui.`)) return;
    // In a real app, this would be an API call to mark customer as banned or delete
    // Example: await apiPut(`/users/${customerIdOrName}`, { isBanned: true });
    alert(`Cliente ${customerIdOrName} banido (apenas visual aqui).`);
    renderClientes(); // Re-render
  }

  // --- Funções de Configurações ---
  async function removerLoja() {
    if (!currentStoreId) return;
    if (!confirm('Tem certeza que deseja remover esta loja? Esta ação é irreversível.')) return;
    try {
        await apiDelete(`/stores/${currentStoreId}`); // API call to delete store
        alert('Loja removida com sucesso!');
        localStorage.removeItem('loja_id'); // Clear current store selection
        window.location.href = "index.html"; // Redirect
    } catch (error) {
        console.error("Erro ao remover loja via API:", error);
        alert(`Erro ao remover loja: ${error.message || 'Verifique o console do navegador e o backend.'}`);
    }
  }

  function sair() {
    localStorage.removeItem('loja_id'); // Clear current store selection
    window.location.href = "index.html"; // Redirect to homepage
  }

  function trocarIdioma() {
    const lang = $('idioma').value;
    localStorage.setItem('dashboard_lang', lang);
    if (lang === 'en') $('titulo').innerText = 'Store Dashboard';
    if (lang === 'es') $('titulo').innerText = 'Panel de la Tienda';
    if (lang === 'pt') $('titulo').innerText = '📊 Dashboard da Loja';
  }

  // Initial load
  initDashboard();

  // Apply saved language
  const savedLang = localStorage.getItem('dashboard_lang') || 'pt';
  if ($('idioma')) $('idioma').value = savedLang;
  trocarIdioma();

</script>
</body>
</html>