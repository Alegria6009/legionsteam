<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(120deg, #1A2980, #26D0CE); /* Fundo admin azul */
      color: white; padding: 20px;
    }
    .container { width: 100%; max-width: 1200px; background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border-radius: 18px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2); }
    h1 { text-align: center; color: #fff; margin-bottom: 25px; }
    .login-panel { text-align: center; margin-top: 50px; }
    .login-panel input { padding: 12px; border-radius: 8px; border: none; margin-bottom: 15px; width: 80%; max-width: 300px; background: rgba(255,255,255,0.2); color: white; }
    .login-panel button { padding: 12px 25px; border-radius: 25px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; }
    .error-message { color: crimson; margin-top: 10px; font-weight: bold; }

    .menu { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .menu button { padding: 10px 18px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: 0.3s; }
    .menu .active, .menu button:hover { background: rgba(255,255,255,0.4); color: black; font-weight: bold; }

    .section { display: none; margin-top: 20px; background: rgba(0,0,0,0.1); padding: 20px; border-radius: 12px; }
    .section.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; }
    .stat-card h3 { margin: 0; font-size: 16px; color: #a2e6ff; }
    .stat-card p { font-size: 24px; font-weight: bold; margin-top: 5px; }

    .data-list { margin-top: 20px; }
    .data-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .data-card p { margin: 5px 0; }
    .data-card img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 1px solid rgba(255,255,255,0.3);}
    .data-card strong { color: #a2e6ff; }
    .btn-action { background: #007bff; border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; margin-left: 10px; }
    .btn-delete { background: crimson; }
    .btn-ban { background: orange; }
    .review-stars { color: #ffd700; }
    select, input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; color: white; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container" id="adminContainer">
    <div id="loginSection" class="login-panel">
      <h1>Admin Login</h1>
      <input type="password" id="adminCode" placeholder="C√≥digo de Acesso">
      <button onclick="loginAdmin()">Entrar</button>
      <p id="loginError" class="error-message" style="display:none;">Acesso negado. C√≥digo incorreto.</p>
    </div>

    <div id="dashboardSection" style="display:none;">
      <h1>üõ†Ô∏è Painel de Administra√ß√£o</h1>

      <div class="menu">
        <button class="active" onclick="showAdminTab(event, 'overview')">Resumo</button>
        <button onclick="showAdminTab(event, 'users')">Usu√°rios</button>
        <button onclick="showAdminTab(event, 'stores')">Lojas</button>
        <button onclick="showAdminTab(event, 'products')">Produtos</button>
        <button onclick="showAdminTab(event, 'orders')">Pedidos</button>
        <button onclick="showAdminTab(event, 'reviews')">Reviews</button>
        <button onclick="logoutAdmin()">Sair</button>
      </div>

      <!-- Overview Section -->
      <section id="overview" class="section active">
        <h2>Vis√£o Geral</h2>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Clientes</h3><p id="totalClients">0</p></div>
          <div class="stat-card"><h3>Total Vendedores</h3><p id="totalSellers">0</p></div>
          <div class="stat-card"><h3>Total Lojas</h3><p id="totalStores">0</p></div>
          <div class="stat-card"><h3>Total Produtos</h3><p id="totalProducts">0</p></div>
          <div class="stat-card"><h3>Pedidos Pendentes</h3><p id="totalPendingOrders">0</p></div>
          <div class="stat-card"><h3>Pedidos Entregues</h3><p id="totalDeliveredOrders">0</p></div>
        </div>
      </section>

      <!-- Users Section -->
      <section id="users" class="section">
        <h2>Gerenciar Usu√°rios</h2>
        <div class="data-list" id="usersList"></div>
      </section>

      <!-- Stores Section -->
      <section id="stores" class="section">
        <h2>Gerenciar Lojas</h2>
        <div class="data-list" id="storesList"></div>
      </section>

      <!-- Products Section -->
      <section id="products" class="section">
        <h2>Gerenciar Produtos</h2>
        <div class="data-list" id="productsList"></div>
      </section>

      <!-- Orders Section -->
      <section id="orders" class="section">
        <h2>Gerenciar Pedidos</h2>
        <div class="data-list" id="ordersList"></div>
      </section>
      
      <!-- Reviews Section -->
      <section id="reviews" class="section">
        <h2>Gerenciar Reviews</h2>
        <div class="data-list" id="reviewsList"></div>
      </section>

    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:5000/api"; // Ajuste para a URL do seu backend
    const ADMIN_CODE = "codex948429014!"; // C√≥digo de acesso do admin

    // Helpers simples (embutidos)
    const $ = id => document.getElementById(id);
    async function apiGet(path){
      const r = await fetch(API_BASE + path);
      if (!r.ok) throw new Error(`Erro na API: ${r.status} ${r.statusText}`);
      return r.json();
    }
    async function apiPost(path, body){
      const r = await fetch(API_BASE + path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(`Erro na API: ${r.status} ${r.statusText}`);
      return r.json();
    }
    async function apiPut(path, body){
      const r = await fetch(API_BASE + path, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(`Erro na API: ${r.status} ${r.statusText}`);
      return r.json();
    }
    async function apiDelete(path){
      const r = await fetch(API_BASE + path, { method: 'DELETE' });
      if (!r.ok) throw new Error(`Erro na API: ${r.status} ${r.statusText}`);
      return r.json();
    }
    const escapeHtml = s => { if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const formatKz = n => 'Kz ' + Number(n||0).toLocaleString('pt-PT');

    // --- Admin Login ---
    function loginAdmin() {
      const code = $('adminCode').value;
      if (code === ADMIN_CODE) {
        localStorage.setItem('admin_logged_in', 'true');
        showAdminDashboard();
      } else {
        $('loginError').style.display = 'block';
      }
    }

    function logoutAdmin() {
      localStorage.removeItem('admin_logged_in');
      showAdminLogin();
    }

    function showAdminLogin() {
      $('loginSection').style.display = 'block';
      $('dashboardSection').style.display = 'none';
      $('adminCode').value = '';
      $('loginError').style.display = 'none';
    }

    function showAdminDashboard() {
      $('loginSection').style.display = 'none';
      $('dashboardSection').style.display = 'block';
      loadOverview(); // Load stats on dashboard entry
    }

    // --- Tab Management ---
    function showAdminTab(evt, tabId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      $(tabId).classList.add('active');
      document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
      if (evt && evt.target) evt.target.classList.add('active');

      if (tabId === 'overview') loadOverview();
      if (tabId === 'users') loadUsers();
      if (tabId === 'stores') loadStores();
      if (tabId === 'products') loadProducts();
      if (tabId === 'orders') loadOrders();
      if (tabId === 'reviews') loadReviews();
    }

    // --- Overview ---
    async function loadOverview() {
      try {
        const users = await apiGet('/users');
        const stores = await apiGet('/stores');
        const orders = await apiGet('/orders');
        let totalProducts = 0;
        stores.forEach(s => totalProducts += (s.produtos ? s.produtos.length : 0));

        const totalClients = users.filter(u => u.role === 'client').length;
        const totalSellers = users.filter(u => u.role === 'seller').length;
        const totalPendingOrders = orders.filter(o => o.status === 'Pendente' || o.status === 'Aguardando Verifica√ß√£o').length;
        const totalDeliveredOrders = orders.filter(o => o.status === 'Entregue' || o.status === 'Recebido').length;

        $('totalClients').innerText = totalClients;
        $('totalSellers').innerText = totalSellers;
        $('totalStores').innerText = stores.length;
        $('totalProducts').innerText = totalProducts;
        $('totalPendingOrders').innerText = totalPendingOrders;
        $('totalDeliveredOrders').innerText = totalDeliveredOrders;
      } catch (error) {
        console.error("Erro ao carregar resumo da API:", error);
        alert("Erro ao carregar resumo. Verifique o backend.");
      }
    }

    // --- Users ---
    async function loadUsers() {
      try {
        const users = await apiGet('/users');
        let html = '';
        users.forEach(u => {
          html += `
            <div class="data-card">
              <img src="${u.photo || 'https://via.placeholder.com/40'}" alt="avatar">
              <div>
                <p><strong>${escapeHtml(u.name)}</strong> (${escapeHtml(u.role || 'client')})</p>
                <p class="small">${escapeHtml(u.emailOrPhone)}</p>
              </div>
              <div>
                <button class="btn-action btn-ban" onclick="toggleBanUser('${u._id}', '${u.name}')">Banir</button>
                <button class="btn-action btn-delete" onclick="deleteUser('${u._id}', '${u.name}')">Excluir</button>
              </div>
            </div>`;
        });
        $('usersList').innerHTML = html || '<p>Nenhum usu√°rio cadastrado.</p>';
      } catch (error) {
        console.error("Erro ao carregar usu√°rios da API:", error);
        $('usersList').innerHTML = '<p>Erro ao carregar usu√°rios.</p>';
      }
    }

    async function deleteUser(userId, userName) {
      if (!confirm(`Tem certeza que deseja EXCLUIR o usu√°rio ${userName}? Esta a√ß√£o √© irrevers√≠vel.`)) return;
      try {
        await apiDelete(`/users/${userId}`); // API call
        alert(`Usu√°rio ${userName} exclu√≠do com sucesso.`);
        loadUsers(); // Reload list
      } catch (error) {
        console.error("Erro ao excluir usu√°rio via API:", error);
        alert(`Erro ao excluir usu√°rio ${userName}.`);
      }
    }
    
    async function toggleBanUser(userId, userName) {
        // Implementar l√≥gica de banimento (PUT /users/:id com isBanned: true)
        alert(`Funcionalidade de banir ${userName} (ID: ${userId}) ser√° implementada no backend (PUT /users/:id).`);
    }

    // --- Stores ---
    async function loadStores() {
      try {
        const stores = await apiGet('/stores');
        let html = '';
        stores.forEach(s => {
          html += `
            <div class="data-card">
              <img src="${s.logo || 'https://via.placeholder.com/40'}" alt="logo loja">
              <div>
                <p><strong>${escapeHtml(s.nome)}</strong> (${escapeHtml(s.categoria)})</p>
                <p class="small">${escapeHtml(s.email)}</p>
              </div>
              <div>
                <button class="btn-action btn-delete" onclick="deleteStore('${s._id}', '${s.nome}')">Excluir</button>
              </div>
            </div>`;
        });
        $('storesList').innerHTML = html || '<p>Nenhuma loja cadastrada.</p>';
      } catch (error) {
        console.error("Erro ao carregar lojas da API:", error);
        $('storesList').innerHTML = '<p>Erro ao carregar lojas.</p>';
      }
    }

    async function deleteStore(storeId, storeName) {
      if (!confirm(`Tem certeza que deseja EXCLUIR a loja ${storeName}? Esta a√ß√£o √© irrevers√≠vel e excluir√° produtos/pedidos/reviews relacionados.`)) return;
      try {
        await apiDelete(`/stores/${storeId}`); // API call
        alert(`Loja ${storeName} exclu√≠da com sucesso.`);
        loadStores(); // Reload list
        // Optional: Also update localStorage.lojas for frontend consistency
      } catch (error) {
        console.error("Erro ao excluir loja via API:", error);
        alert(`Erro ao excluir loja ${storeName}.`);
      }
    }

    // --- Products ---
    async function loadProducts() {
      try {
        const stores = await apiGet('/stores');
        let html = '';
        if (stores.length === 0) {
            html = '<p>Nenhuma loja com produtos cadastrados.</p>';
        } else {
            for (const s of stores) {
                if (s.produtos && s.produtos.length > 0) {
                    html += `<h3>Produtos da Loja: ${escapeHtml(s.nome)}</h3>`;
                    s.produtos.forEach((p, idx) => {
                        html += `
                            <div class="data-card">
                                <img src="${p.foto || 'https://via.placeholder.com/40'}" alt="produto">
                                <div>
                                    <p><strong>${escapeHtml(p.nome)}</strong> (Kz ${formatKz(p.preco)})</p>
                                    <p class="small">${escapeHtml(p.desc || '')} - Stock: ${escapeHtml(p.estoque)}</p>
                                </div>
                                <div>
                                    <button class="btn-action btn-delete" onclick="deleteProduct('${s._id}', '${p._id}', ${idx})">Excluir</button>
                                </div>
                            </div>`;
                    });
                }
            }
        }
        $('productsList').innerHTML = html || '<p>Nenhum produto cadastrado.</p>';
      } catch (error) {
        console.error("Erro ao carregar produtos da API:", error);
        $('productsList').innerHTML = '<p>Erro ao carregar produtos.</p>';
      }
    }

    async function deleteProduct(storeId, productId, productLocalIndex) {
        if (!confirm('Tem certeza que deseja EXCLUIR este produto?')) return;
        try {
            // Chamamos a rota DELETE por local index como configurado no backend
            await apiDelete(`/products/${storeId}/${productLocalIndex}`); // API call
            alert('Produto exclu√≠do com sucesso.');
            loadProducts(); // Recarrega todos os produtos
        } catch (error) {
            console.error("Erro ao excluir produto via API:", error);
            alert('Erro ao excluir produto.');
        }
    }

    // --- Orders ---
    async function loadOrders() {
      try {
        const orders = await apiGet('/orders');
        let html = '';
        orders.forEach(o => {
          const statusColor = { 'Pendente': 'red', 'Aguardando Verifica√ß√£o': 'orange', 'Entregue': 'gold', 'Recebido': 'limegreen' }[o.status] || 'white';
          html += `
            <div class="data-card">
              <img src="${o.customerPhoto || 'https://via.placeholder.com/40'}" alt="cliente avatar">
              <div>
                <p><strong>Pedido #${o.id}</strong> - Loja: ${o.storeName || 'N/D'}</p>
                <p class="small">Cliente: ${escapeHtml(o.customerName)} (${escapeHtml(o.customerEmail || o.customerPhone)})</p>
                <p class="small">Total: ${formatKz(o.total)} | Status: <span style="color:${statusColor}"><strong>${escapeHtml(o.status)}</strong></span></p>
              </div>
              <div>
                <button class="btn-action" onclick="updateOrderStatusAdmin('${o._id}', '${o.status}')">Mudar Status</button>
                <button class="btn-action btn-delete" onclick="deleteOrder('${o._id}')">Excluir</button>
              </div>
            </div>`;
        });
        $('ordersList').innerHTML = html || '<p>Nenhum pedido no sistema.</p>';
      } catch (error) {
        console.error("Erro ao carregar pedidos da API:", error);
        $('ordersList').innerHTML = '<p>Erro ao carregar pedidos.</p>';
      }
    }

    async function updateOrderStatusAdmin(orderId, currentStatus) {
      const newStatus = prompt(`Mudar status do pedido ${orderId} de "${currentStatus}" para: (Pendente, Aguardando Verifica√ß√£o, Entregue, Recebido)`);
      if (!newStatus || !['Pendente', 'Aguardando Verifica√ß√£o', 'Entregue', 'Recebido'].includes(newStatus)) {
        if (newStatus) alert('Status inv√°lido. Use um dos sugeridos.');
        return;
      }
      try {
        await apiPut(`/orders/${orderId}`, { status: newStatus, log: `Status alterado pelo Admin em ${new Date().toLocaleString()}` }); // API call
        alert('Status do pedido atualizado.');
        loadOrders(); // Recarrega lista
        // Optional: sync with localStorage.pedidos_cliente & pedidos_vendedor
      } catch (error) {
        console.error("Erro ao atualizar status do pedido via API:", error);
        alert('Erro ao atualizar status do pedido.');
      }
    }

    async function deleteOrder(orderId) {
      if (!confirm('Tem certeza que deseja EXCLUIR este pedido? Esta a√ß√£o √© irrevers√≠vel.')) return;
      try {
        await apiDelete(`/orders/${orderId}`); // API call
        alert('Pedido exclu√≠do com sucesso.');
        loadOrders(); // Recarrega lista
        // Optional: sync with localStorage.pedidos_cliente & pedidos_vendedor
      } catch (error) {
        console.error("Erro ao excluir pedido via API:", error);
        alert('Erro ao excluir pedido.');
      }
    }

    // --- Reviews ---
    async function loadReviews() {
      try {
        const reviews = await apiGet('/reviews');
        let html = '';
        reviews.forEach(r => {
          const stars = '‚òÖ'.repeat(r.rating || 5) + '‚òÜ'.repeat(5 - (r.rating || 5));
          html += `
            <div class="data-card">
              <img src="${r.customerPhoto || 'https://via.placeholder.com/30'}" alt="avatar">
              <div>
                <p><strong>${escapeHtml(r.customerName)}</strong> - ${escapeHtml(r.productName)} (${stars})</p>
                <p class="small">${escapeHtml(r.text)} - ${escapeHtml(r.createdAt || r.log || '')}</p>
              </div>
              <div>
                <button class="btn-action btn-delete" onclick="deleteReview('${r._id}')">Excluir</button>
              </div>
            </div>`;
        });
        $('reviewsList').innerHTML = html || '<p>Nenhum review no sistema.</p>';
      } catch (error) {
        console.error("Erro ao carregar reviews da API:", error);
        $('reviewsList').innerHTML = '<p>Erro ao carregar reviews.</p>';
      }
    }

    async function deleteReview(reviewId) {
        if (!confirm('Tem certeza que deseja EXCLUIR este review?')) return;
        try {
            await apiDelete(`/reviews/${reviewId}`); // API call
            alert('Review exclu√≠do com sucesso.');
            loadReviews(); // Recarrega lista
        } catch (error) {
            console.error("Erro ao excluir review via API:", error);
            alert('Erro ao excluir review.');
        }
    }


    // --- Initial Check (on page load) ---
    (function initAdminPage() {
      if (localStorage.getItem('admin_logged_in') === 'true') {
        showAdminDashboard();
      } else {
        showAdminLogin();
      }
    })();
  </script>
</body>
</html>