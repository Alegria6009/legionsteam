<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Produto - Marketplace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style> 
    :root{ --bg1:#0f2027; --bg2:#203a43; --glass:rgba(255,255,255,0.06); --accent:#ff9800; --muted:rgba(255,255,255,0.7); --white:#fff; }
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:var(--white);padding:20px}
    .wrap{width:100%;max-width:1100px;margin:0 auto}
    .card{background:var(--glass);backdrop-filter: blur(12px);border-radius:14px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.05)}
    h1{margin:0 0 12px;color:var(--accent);text-align:center}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
    .gallery{background:rgba(0,0,0,0.04);padding:12px;border-radius:10px}
    .main-img{width:100%;height:420px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
    .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent}
    .thumbs img.active{border-color:var(--accent)}
    .info{margin-top:16px}
    .price{font-size:22px;color:var(--accent);font-weight:700;margin-top:8px}
    .stock{font-size:14px;color:var(--muted);margin-top:6px}
    .desc{margin-top:10px;color:var(--muted);line-height:1.5}

    .panel{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px}
    label{display:block;font-size:13px;margin-top:12px;color:var(--muted)}
    select,input[type="text"],input[type="email"],input[type="number"],textarea{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.22);color:var(--white);margin-top:6px}
    .btn{display:inline-block;background:linear-gradient(135deg,var(--accent),#e6b800);border:none;padding:12px 16px;border-radius:12px;color:#111;font-weight:700;cursor:pointer;margin-top:12px}
    .btn.secondary{background:rgba(255,255,255,0.12);color:var(--white)}
    .seller{margin-top:14px;color:var(--muted)}
    .reviews{margin-top:14px}
    .review{background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-bottom:8px}
    .stars{color:var(--accent)}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    .small{font-size:13px;color:var(--muted)}

    .help { font-size:13px;color:var(--muted);margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap card" role="main">
    <h1 id="title">Produto</h1>

    <div class="grid">
      <!-- Left -->
      <div>
        <div class="gallery">
          <img id="mainImage" class="main-img" src="https://via.placeholder.com/800x500" alt="Imagem do produto">
          <div class="thumbs" id="thumbs" aria-hidden="false"></div>
        </div>

        <div class="info">
          <h2 id="productName">Nome do Produto</h2>
          <div class="price" id="productPrice">Kz 0</div>
          <div class="stock" id="productStock">Stock: 0</div>
          <div class="desc" id="productDesc">Descrição...</div>
        </div>
      </div>

      <!-- Right -->
      <aside class="panel" aria-labelledby="purchase-heading">
        <h3 id="purchase-heading">Comprar</h3>

        <label for="qty">Quantidade</label>
        <input id="qty" type="number" min="1" value="1">

        <button class="btn" id="addCartBtn">Adicionar ao Carrinho</button>
        <button class="btn secondary" id="buyNowBtn">Comprar Agora</button>

        <div class="seller" id="sellerInfo" aria-live="polite"></div>

        <div class="reviews" id="reviewsSection">
          <h4>Avaliações</h4>
          <div id="avgRating" class="note"></div>
          <div id="reviewsList"></div>
        </div>

        <div id="reviewForm" style="margin-top:12px">
          <h4>Deixar avaliação</h4>
          <select id="starRating">
            <option value="5">5 ★★★★★</option>
            <option value="4">4 ★★★★</option>
            <option value="3">3 ★★★</option>
            <option value="2">2 ★★</option>
            <option value="1">1 ★</option>
          </select>
          <textarea id="reviewText" rows="3" placeholder="Escreva sua avaliação..."></textarea>
          <div class="note" id="reviewNote"></div>
          <button class="btn" id="submitReviewBtn">Enviar Avaliação</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // --- JS BASE (INCLUA ESTE BLOCO EM CADA HTML) ---
    const API_BASE = "http://localhost:5000/api"; // <<<< AJUSTAR CONFORME SEU BACKEND

    const $ = id => document.getElementById(id); // Helper para document.getElementById
    const escapeHtml = s => { if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const formatKz = n => 'Kz ' + Number(n||0).toLocaleString('pt-PT');
    const uid = () => Date.now() + Math.floor(Math.random()*900); // Gerador de ID único

    async function apiGet(path){
      const r = await fetch(API_BASE + path);
      if (!r.ok) { const errorBody = await r.text(); console.error(`API GET ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
      return r.json();
    }
    async function apiPost(path, body){
      const r = await fetch(API_BASE + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) { const errorBody = await r.text(); console.error(`API POST ${path} Error:`, r.status, r.statusText, errorBody); throw new Error(`Erro na API (${r.status}): ${r.statusText}. Detalhes: ${errorBody.substring(0, 100)}`); }
      return r.json();
    }
    // Outros helpers (apiPut, apiDelete) seriam definidos aqui se fossem necessários nesta página
    // --- FIM DO JS BASE ---

    let currentStoreId = null; // MongoDB _id da loja
    let currentProductId = null; // MongoDB _id do produto
    let currentProductLocalIndex = null; // Índice local do produto (dentro do array store.produtos)

    // Get selection from URL parameters
    function getSelection(){
      const params = new URLSearchParams(window.location.search);
      const storeId = params.get('storeId'); // MongoDB _id da loja
      const productLocalIndex = params.get('productLocalIndex'); // Índice local do produto
      
      if(storeId && productLocalIndex !== null) {
          return { storeId: storeId, productLocalIndex: parseInt(productLocalIndex, 10) };
      }
      return null;
    }

    const sel = getSelection();
    if(!sel){
      document.body.innerHTML = '<div style="padding:40px;color:#fff">Produto não selecionado ou loja inválida. Volte à lista de lojas.</div>';
      throw new Error('Produto não selecionado');
    }
    const { storeId, productLocalIndex } = sel;
    currentStoreId = storeId;
    currentProductLocalIndex = productLocalIndex;

    (async function initProductPage(){
      try {
        const store = await apiGet(`/stores/${currentStoreId}`); // Fetch store by _id
        if (!store) throw new Error('Loja não encontrada na API.');

        const products = store.produtos || []; // Products are embedded in Store
        const product = products[currentProductLocalIndex]; // Get product by local index
        if (!product) throw new Error('Produto não encontrado na loja.');
        currentProductId = product._id; // Set actual product _id for backend ref

        // Render Product Details
        $('title').innerText = product.nome + ' — ' + store.nome;
        $('productName').innerText = product.nome;
        $('productPrice').innerText = formatKz(product.preco);
        $('productStock').innerText = 'Stock: ' + (product.estoque ?? 0);
        $('productDesc').innerText = product.desc || '';

        // Images
        const images = [];
        if(product.foto) images.push(product.foto); 
        if(images.length===0) images.push('https://via.placeholder.com/800x500');

        $('mainImage').src = images[0];
        const thumbs = $('thumbs'); thumbs.innerHTML = '';
        images.forEach((src,i)=>{
          const img = document.createElement('img'); img.src = src; img.alt = product.nome + ' ' + (i+1);
          if(i===0) img.classList.add('active');
          img.addEventListener('click', ()=>{ $('mainImage').src = src; document.querySelectorAll('#thumbs img').forEach(n=>n.classList.remove('active')); img.classList.add('active'); });
          thumbs.appendChild(img);
        });

        // Seller Info
        $('sellerInfo').innerHTML = `<div><strong>${escapeHtml(store.nome)}</strong></div><div class="small">Contato: ${escapeHtml(store.email||'')}${store.telefone ? ' | ' + escapeHtml(store.telefone): ''}</div><div style="margin-top:8px"><button class="btn secondary" onclick="verLoja('${currentStoreId}')">Ver Loja</button></div>`;

        // Load Reviews
        await loadReviews();
        // Setup Review Form availability
        setupReviewForm();

      } catch (error) {
        console.error("Erro ao carregar dados do produto/loja da API:", error);
        document.body.innerHTML = '<div style="padding:40px;color:#fff">Erro ao carregar produto. Verifique o console do navegador e o backend.</div>';
      }
    })();

    // --- Events & Functions ---
    $('addCartBtn').addEventListener('click', ()=>{
      const qty = Math.max(1, parseInt($('qty').value||1,10));
      const stock = Number($('productStock').innerText.replace('Stock: ','')||0);
      if(qty > stock){ alert('Quantidade maior que o stock disponível.'); return; }
      const cart = JSON.parse(localStorage.getItem('carrinho_cliente')||'[]');
      cart.push({ storeId: currentStoreId, productLocalIndex: currentProductLocalIndex, productId: currentProductId, nome: $('productName').innerText, preco: parseFloat($('productPrice').innerText.replace('Kz ','').replace(',','.')), qty });
      localStorage.setItem('carrinho_cliente', JSON.stringify(cart));
      alert('Produto adicionado ao carrinho!');
    });

    $('buyNowBtn').addEventListener('click', ()=>{
      localStorage.setItem('checkout_store_id', currentStoreId); // Pass store ID
      localStorage.setItem('checkout_product_data', JSON.stringify({storeId: currentStoreId, productLocalIndex: currentProductLocalIndex, productId: currentProductId, qty: Math.max(1, parseInt($('qty').value||1,10)), nome: $('productName').innerText, preco: parseFloat($('productPrice').innerText.replace('Kz ','').replace(',','.')) }));
      window.location.href = 'checkout.html';
    });

    function verLoja(storeId){
      localStorage.setItem('loja_id', storeId);
      window.location.href='loja.html';
    }

    async function loadReviews(){
      try {
        const reviews = await apiGet(`/reviews?storeId=${currentStoreId}&productName=${encodeURIComponent($('productName').innerText)}`); 
        const list = $('reviewsList'); list.innerHTML = '';
        if(!reviews || reviews.length===0){ $('avgRating').innerText='Sem avaliações'; return; }
        let sum = 0; reviews.forEach(r=>{
          sum += Number(r.rating||5);
          const div = document.createElement('div'); div.className='review';
          const stars = '★'.repeat(r.rating||5) + '☆'.repeat(5-(r.rating||5));
          div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><img src="${r.customerPhoto||'https://via.placeholder.com/30'}" style="width:30px;height:30px;border-radius:50%"><strong>${escapeHtml(r.customerName)}</strong> <span class="small" style="margin-left:8px">${stars}</span></div><div style="margin-top:6px">${escapeHtml(r.text)}</div><div class="small" style="margin-top:6px">${escapeHtml(r.createdAt || r.log || '')}</div>`;
          list.appendChild(div);
        });
        const avg = sum / reviews.length;
        $('avgRating').innerText = `Média: ${avg.toFixed(1)} ★ (${reviews.length})`;
      } catch (error) {
        console.error("Erro ao carregar reviews da API:", error);
        $('reviewsList').innerHTML = '<p>Erro ao carregar avaliações.</p>';
      }
    }

    function purchasedByClient(){
      const clienteId = localStorage.getItem('cliente_id'); 
      if(!clienteId) return false;
      const pedidos = JSON.parse(localStorage.getItem('pedidos_cliente')||'[]');
      for(const p of pedidos){
        if(String(p.storeId) !== String(currentStoreId)) continue;
        if(p.status === 'Recebido' || p.status === 'Entregue'){
          if(Array.isArray(p.items)){
            for(const it of p.items){
              if(String(it.productId) === String(currentProductId) || String(it.nome) === String($('productName').innerText)) return true;
            }
          }
        }
      }
      return false;
    }

    function setupReviewForm(){
      const ok = purchasedByClient();
      if(!ok){
        $('reviewNote').innerText = 'Apenas clientes que compraram este produto podem avaliar.';
        $('starRating').disabled = true; $('reviewText').disabled = true; $('submitReviewBtn').disabled = true;
      } else {
        $('reviewNote').innerText = '';
        $('starRating').disabled = false; $('reviewText').disabled = false; $('submitReviewBtn').disabled = false;
      }
    }

    $('submitReviewBtn').addEventListener('click', async ()=>{
      if(!purchasedByClient()){ alert('Só clientes que compraram podem avaliar.'); return; }
      const texto = $('reviewText').value.trim();
      const nota = parseInt($('starRating').value||5,10);
      if(!texto){ alert('Escreva um comentário.'); return; }
      const cliente = localStorage.getItem('cliente_nome') || 'Cliente';
      const foto = localStorage.getItem('cliente_foto') || '';
      
      try {
        await apiPost('/reviews', { 
            store: currentStoreId, 
            productName: $('productName').innerText, 
            customerName: cliente, 
            customerPhoto: foto, 
            rating: nota, 
            text: texto 
        });
        $('reviewText').value = '';
        await loadReviews();
        alert('Obrigado pela avaliação!');
      } catch (error) {
        console.error("Erro ao enviar review:", error);
        alert("Erro ao enviar avaliação. Tente novamente.");
      }
    });

    // Initial load
    initProductPage();
  </script>
</body>
</html>